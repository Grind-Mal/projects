name: Sync Projects JSON

on:
  issues:
    types: [labeled, unlabeled, reopened, closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update projects.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            const file = "projects.json";
            let data = fs.existsSync(file)
              ? JSON.parse(fs.readFileSync(file))
              : [];

            // Ensure data is an array
            if (!Array.isArray(data)) {
              console.log("Warning: projects.json does not contain an array, initializing as empty array");
              data = [];
            }

            const index = data.findIndex(p => p.id === issue.number);

            const project = {
              id: issue.number,
              title: issue.title,
              repo: issue.body.match(/https?:\/\/github\.com\/\S+/)?.[0] || "",
              status: labels.find(l => l.startsWith("status:")) || "",
              type: labels.find(l => l.startsWith("type:")) || "",
              submitted_by: issue.user.login,
              issue_url: issue.html_url,
              updated_at: new Date().toISOString()
            };

            if (index === -1) data.push(project);
            else data[index] = { ...data[index], ...project };

            fs.writeFileSync(file, JSON.stringify(data, null, 2));

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "sync projects.json"
          title: "Sync projects.json"
          body: "Auto-generated update from issue activity"
          branch: create-pull-request/patch
          add-paths: "projects.json"
          delete-branch: true
